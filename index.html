<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ImanPlay - Prayer Reminder</title>
<link href="https://fonts.googleapis.com/css2?family=Amiri&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Roboto', sans-serif;
    background: linear-gradient(to bottom, #f0f8ff, #d6eaf8);
    margin: 0;
    padding: 0;
    text-align: center;
    color: #333;
  }
  header {
    padding: 20px;
    background-color: #0b3d91;
    color: white;
    font-family: 'Amiri', serif;
    font-size: 2rem;
  }
  main {
    padding: 30px;
  }
  .prayer-times {
    margin: 20px auto;
    max-width: 400px;
    background-color: #ffffffcc;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
  }
  .prayer-times h2 {
    margin-top: 0;
    font-family: 'Amiri', serif;
    color: #0b3d91;
  }
  .prayer-time {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    font-size: 1.2rem;
  }
  button {
    background-color: #0b3d91;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 10px;
    font-size: 1rem;
    cursor: pointer;
    margin-top: 20px;
    transition: 0.3s;
  }
  button:hover {
    background-color: #0654b3;
  }
  #overlay {
    display: none; /* hidden by default */
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background-color: rgba(11,61,145,0.95);
    z-index: 9999;
    color: white;
    font-size: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    pointer-events: all;
  }
  #overlay p {
    font-family: 'Amiri', serif;
    margin-bottom: 20px;
  }
</style>
</head>
<body>

<header>ImanPlay - Prayer Reminder</header>

<main>
  <div class="prayer-times">
    <h2>Prayer Times</h2>
    <div class="prayer-time"><span>Fajr</span><span id="fajr">--:--</span></div>
    <div class="prayer-time"><span>Dhuhr</span><span id="dhuhr">--:--</span></div>
    <div class="prayer-time"><span>Asr</span><span id="asr">--:--</span></div>
    <div class="prayer-time"><span>Maghrib</span><span id="maghrib">--:--</span></div>
    <div class="prayer-time"><span>Isha</span><span id="isha">--:--</span></div>
  </div>

  <button id="sampleNotification">Show Sample Side Notification üîî</button>
</main>

<div id="overlay">
  <p>Time to Pray! üôè</p>
  <p>You cannot leave this tab for 7 minutes</p>
</div>

<audio id="praySound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"></audio>

<script>
const praySound = document.getElementById('praySound');
const overlay = document.getElementById('overlay');

// Warn user if they try to close tab during overlay
window.addEventListener("beforeunload", function (e) {
  if (overlay.style.display === "flex") {
    e.preventDefault();
    e.returnValue = "You are in prayer time! Are you sure you want to leave?";
  }
});

// Request notification permission
if (Notification.permission !== "granted") {
  Notification.requestPermission();
}

// Show a small side notification
function showSideNotification(title, body) {
  if (Notification.permission === "granted") {
    const notification = new Notification(title, { 
      body: body, 
      icon: "https://cdn-icons-png.flaticon.com/512/616/616408.png"
    });
    praySound.play();
  }
}

// Show full-screen overlay for 7 minutes
function startOverlay() {
  overlay.style.display = "flex";
  praySound.play();
  document.body.style.pointerEvents = "none";
  overlay.style.pointerEvents = "all";

  setTimeout(() => {
    overlay.style.display = "none";
    document.body.style.pointerEvents = "auto";
  }, 7 * 60 * 1000); // 7 minutes
}

// Sample side notification button
document.getElementById('sampleNotification').addEventListener('click', () => {
  showSideNotification("Dhuhr in 5 minutes", "Click this small notification to trigger overlay");
});

// Fetch prayer times from Aladhan API
function fetchPrayerTimes(lat, lon) {
  fetch(`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=4`)
    .then(res => res.json())
    .then(data => {
      if (data.code === 200) {
        const timings = data.data.timings;
        document.getElementById('fajr').textContent = timings.Fajr;
        document.getElementById('dhuhr').textContent = timings.Dhuhr;
        document.getElementById('asr').textContent = timings.Asr;
        document.getElementById('maghrib').textContent = timings.Maghrib;
        document.getElementById('isha').textContent = timings.Isha;

        scheduleNotifications(timings);
      }
    })
    .catch(err => console.error(err));
}

// Schedule notifications
function scheduleNotifications(timings) {
  const prayerOrder = ['Fajr','Dhuhr','Asr','Maghrib','Isha'];
  const now = new Date();

  prayerOrder.forEach(prayer => {
    const [hour, minute] = timings[prayer].split(':');
    const prayerTime = new Date();
    prayerTime.setHours(parseInt(hour), parseInt(minute),0,0);

    const sideNotificationTime = new Date(prayerTime.getTime() - 5*60*1000); // 5 mins before

    // Side notification
    let sideTimeout = sideNotificationTime - now;
    if (sideTimeout > 0) {
      setTimeout(() => {
        showSideNotification(`${prayer} in 5 minutes`, "Get ready to pray!");
      }, sideTimeout);
    }

    // Full overlay
    let overlayTimeout = prayerTime - now;
    if (overlayTimeout > 0) {
      setTimeout(() => {
        startOverlay();
      }, overlayTimeout);
    }
  });
}

// Get user location
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(pos => {
    fetchPrayerTimes(pos.coords.latitude, pos.coords.longitude);
  }, err => {
    console.error("Geolocation failed, using Oakville default.");
    fetchPrayerTimes(43.4675, -79.6877); // Oakville fallback
  });
} else {
  console.error("Geolocation not supported, using Oakville default.");
  fetchPrayerTimes(43.4675, -79.6877);
}
</script>
</body>
</html>
