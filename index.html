<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ImanPlay â€” Prayer reminders</title>

  <link href="./manifest.json" rel="manifest">
  <link href="https://fonts.googleapis.com/css2?family=Amiri&family=Poppins:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#081629; --card:#0f2140; --accent:#00ffcc; --muted:rgba(255,255,255,0.75); --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Poppins,system-ui,Segoe UI,Roboto;background:linear-gradient(180deg,var(--bg) 0%, #072338 100%);color:#fff;min-height:100vh}
    header{display:flex;align-items:center;gap:12px;padding:18px 20px;background:linear-gradient(90deg,rgba(255,255,255,0.02),transparent);position:sticky;top:0;z-index:10}
    header img{width:36px;height:36px}
    .container{max-width:1000px;margin:20px auto;display:grid;grid-template-columns:1fr 340px;gap:18px;padding:0 16px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 30px rgba(0,0,0,0.5)}
    .times .row{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;margin-bottom:8px;transition:transform .18s}
    .times .row:hover{transform:translateY(-4px)}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--accent)}
    .small{font-size:13px;color:var(--muted)}
    button.btn{background:var(--glass);border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:8px;color:var(--muted);cursor:pointer}
    button.btn.primary{background:linear-gradient(90deg,#0ea387,#075a87);color:#021217;border:0}
    #overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,12,0.9);z-index:9999}
    #overlay .card{max-width:600px;text-align:center}
    #countdown{font-size:48px;color:var(--accent);margin-top:10px}
    .tracker-list{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
    .badge{display:inline-block;padding:6px 8px;border-radius:999px;background:linear-gradient(90deg,#072b4a,#0a6e77);color:#fff;margin-right:6px;font-weight:600}
    .taraweeh{display:flex;gap:8px;align-items:center}
    footer{max-width:1000px;margin:18px auto;color:var(--muted);font-size:13px;padding:0 16px}
    @media (max-width:900px){.container{grid-template-columns:1fr}}
  </style>
</head>
<body>

<header>
  <img src="./icons/mosque.svg" alt="mosque">
  <div style="font-family:Amiri;font-size:20px">ImanPlay</div>
  <div style="margin-left:auto;display:flex;gap:8px">
    <button id="enableBtn" class="btn">Enable notifications & sound</button>
    <button id="testBtn" class="btn">Test alert</button>
  </div>
</header>

<main class="container">

  <section class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-weight:700;font-size:18px">Today's Prayer Times</div>
        <div id="gregDate" class="small"></div>
      </div>
      <div id="hijriDate" class="small"></div>
    </div>

    <div class="times" id="times" style="margin-top:12px">
      <div class="row"><div><span class="dot"></span>&nbsp;<strong>Fajr</strong></div><div id="fajr">--:--</div></div>
      <div class="row"><div><span class="dot"></span>&nbsp;<strong>Dhuhr</strong></div><div id="dhuhr">--:--</div></div>
      <div class="row"><div><span class="dot"></span>&nbsp;<strong>Asr</strong></div><div id="asr">--:--</div></div>
      <div class="row"><div><span class="dot"></span>&nbsp;<strong>Maghrib</strong></div><div id="maghrib">--:--</div></div>
      <div class="row"><div><span class="dot"></span>&nbsp;<strong>Isha</strong></div><div id="isha">--:--</div></div>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
      <div class="small">Next: <strong id="nextPrayer">â€”</strong></div>
      <div class="small">In: <strong id="timeUntil">â€”</strong></div>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
      <label class="small">Adhan:</label>
      <select id="soundSelect" class="btn">
        <option value="digital">Digital</option>
        <option value="adhan1">Adhan (call)</option>
      </select>
      <label class="small" style="margin-left:8px">Lock (mins):</label>
      <input id="lockRange" type="range" min="1" max="15" value="7" />
      <span id="lockLabel" class="small">7m</span>
    </div>
  </section>

  <aside style="display:flex;flex-direction:column;gap:12px">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Salah Tracker</div>
        <div><span id="streakBadge" class="badge">Streak 0</span></div>
      </div>

      <div class="tracker-list" id="tracker"></div>

      <div style="margin-top:10px" class="small">
        Mark prayers as done to track your progress. Streak increases when all five prayers are marked in a day.
      </div>

      <div style="margin-top:12px">
        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
          <div>
            <div style="font-weight:700">Taraweeh counter</div>
            <div class="small">Use this during Ramadan</div>
          </div>
          <div class="taraweeh">
            <button id="taraDec" class="btn">-</button>
            <div id="taraCount" style="min-width:32px;text-align:center;font-weight:700">0</div>
            <button id="taraInc" class="btn">+</button>
          </div>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="resetTara" class="btn">Reset</button>
          <button id="badgesBtn" class="btn">Show badges</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:700">Hadith & Dua</div>
      <div id="hadith" class="small" style="margin-top:8px">Loading...</div>
      <div id="dua" class="small" style="margin-top:8px">Loading...</div>
    </div>

  </aside>

</main>

<div id="overlay" aria-hidden="true">
  <div class="card">
    <h1 style="font-family:Amiri">ðŸ•Œ Time To Pray</h1>
    <p class="small">Focus for the prayer â€” screen locked</p>
    <div id="countdown">07:00</div>
    <div style="margin-top:12px"><button id="endLock" class="btn">End early</button></div>
  </div>
</div>

<footer>Serve on HTTPS or open on localhost so notifications & geolocation work.</footer>

<script>
/* Client-only: uses Aladhan public API and Service Worker for OS notifications.
   Important: Service Worker registration uses a relative path so it works under GitHub Pages subpath.
*/

const SOUND_MAP = { digital: 'https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg', adhan1: 'https://upload.wikimedia.org/wikipedia/commons/9/9d/Adhan.ogg' };
const MOSQUE_ICON = './icons/mosque.svg';
const ids = ['Fajr','Dhuhr','Asr','Maghrib','Isha'];
const timesEls = { Fajr: document.getElementById('fajr'), Dhuhr: document.getElementById('dhuhr'), Asr: document.getElementById('asr'), Maghrib: document.getElementById('maghrib'), Isha: document.getElementById('isha') };
const nextPrayerEl = document.getElementById('nextPrayer'), timeUntilEl = document.getElementById('timeUntil');
const hijriDateEl = document.getElementById('hijriDate'), gregDateEl = document.getElementById('gregDate');
const enableBtn = document.getElementById('enableBtn'), testBtn = document.getElementById('testBtn');
const soundSelect = document.getElementById('soundSelect'), lockRange = document.getElementById('lockRange'), lockLabel = document.getElementById('lockLabel');
const overlay = document.getElementById('overlay'), countdown = document.getElementById('countdown'), endLock = document.getElementById('endLock');

let timers = [], todaysTimings = null, lockInterval = null, locked = false;
const audio = new Audio(); audio.preload = 'auto'; audio.src = SOUND_MAP[soundSelect.value];

// register SW using relative path so scope = repo path on GitHub Pages
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').then(() => console.log('SW registered')).catch(e=>console.warn('SW failed', e));
}

// request permission and enable audio via gesture
enableBtn.addEventListener('click', async () => {
  if ('Notification' in window) {
    try { await Notification.requestPermission(); } catch(e){}
  }
  try { await audio.play(); audio.pause(); audio.currentTime = 0; } catch(e){}
  enableBtn.classList.add('primary');
});

// test button
testBtn.addEventListener('click', async () => {
  await showSystemNotification('ImanPlay â€” Test', 'This is a test notification');
  playAdhan();
});

// UI wiring
soundSelect.addEventListener('change', ()=> { audio.src = SOUND_MAP[soundSelect.value] || SOUND_MAP.digital; localStorage.setItem('sound', soundSelect.value); });
lockRange.addEventListener('input', ()=> lockLabel.textContent = lockRange.value + 'm');

// unified notification helper (waits for SW ready and uses reg.showNotification)
async function showSystemNotification(title, body, options = {}) {
  options = Object.assign({ body, icon: MOSQUE_ICON, badge: MOSQUE_ICON }, options);
  try {
    if ('serviceWorker' in navigator) {
      const reg = await navigator.serviceWorker.ready;
      if (reg && reg.showNotification) {
        reg.showNotification(title, options);
        return;
      }
    }
  } catch(e) {
    console.warn('SW showNotification failed', e);
  }
  if (Notification && Notification.permission === 'granted') {
    try { new Notification(title, options); } catch(e) { console.warn('Notification failed', e); }
  }
}

function playAdhan(){ if (audio.muted) return; audio.currentTime = 0; audio.play().catch(()=>{}); }

// Aladhan fetch & schedule
function loadTimes(lat = 43.4675, lon = -79.6877) {
  fetch(`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=2`)
    .then(r=>r.json()).then(d=>{
      const t = d.data.timings, date = d.data.date;
      ids.forEach(p=>{ if (timesEls[p]) timesEls[p].textContent = t[p]; });
      todaysTimings = t;
      if (date && date.hijri) hijriDateEl.textContent = `${date.hijri.day} ${date.hijri.month.en} ${date.hijri.year} AH`;
      else hijriDateEl.textContent = new Intl.DateTimeFormat('en-u-ca-islamic',{day:'numeric',month:'long',year:'numeric'}).format(new Date());
      gregDateEl.textContent = new Date().toLocaleString(undefined,{weekday:'long',month:'long',day:'numeric'});
      scheduleReminders(t);
      updateNext();
      setInterval(updateNext, 1000);
    }).catch(err=>{
      console.warn('Aladhan fetch error', err);
      const fallback = { Fajr:'05:00', Dhuhr:'12:30', Asr:'15:30', Maghrib:'18:00', Isha:'19:30' };
      Object.keys(fallback).forEach(k=> timesEls[k].textContent = fallback[k]);
      todaysTimings = fallback;
      scheduleReminders(fallback);
      updateNext();
      setInterval(updateNext, 1000);
    });
}

function timeToDate(today, hhmm){ const [hh,mm]=hhmm.split(':').map(s=>parseInt(s,10)); return new Date(today.getFullYear(), today.getMonth(), today.getDate(), hh, mm, 0, 0); }
function clearTimers(){ timers.forEach(t=>clearTimeout(t)); timers=[]; }

function scheduleReminders(times){
  clearTimers();
  const now = new Date(), today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  ids.forEach(name=>{
    const t = times[name]; if(!t) return;
    const pray = timeToDate(today, t);
    if (pray <= now) return; // skip passed
    const before = new Date(pray.getTime() - 5*60*1000);
    if (before > now) timers.push(setTimeout(()=> { showSystemNotification(`${name} in 5 minutes`, 'Prepare for Salah'); playAdhan(); }, before - now));
    timers.push(setTimeout(()=> { showSystemNotification(`${name} time`, `It's time for ${name}`); playAdhan(); openLock(parseInt(lockRange.value||'7',10)); }, pray - now));
  });
}

// next prayer display + countdown
function updateNext(){
  if(!todaysTimings) return;
  const now=new Date(), today=new Date(now.getFullYear(), now.getMonth(), now.getDate());
  let next=null, nextTime=null;
  for(const name of ids){
    const t = todaysTimings[name]; if(!t) continue;
    const dt = timeToDate(today, t);
    if(dt>now){ next=name; nextTime=dt; break; }
  }
  if(!next){
    const [h,m] = (todaysTimings['Fajr']||'05:00').split(':').map(s=>parseInt(s,10));
    next='Fajr'; nextTime = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, h, m, 0, 0);
  }
  nextPrayerEl.textContent = `${next} (${pad(nextTime.getHours())}:${pad(nextTime.getMinutes())})`;
  const secs = Math.max(0, Math.floor((nextTime - now)/1000));
  timeUntilEl.textContent = humanRemaining(secs);
}
function humanRemaining(s){ const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=s%60; if(h>0) return `${h}h ${m}m`; if(m>0) return `${m}m ${sec}s`; return `${sec}s`; }
function pad(n){ return String(n).padStart(2,'0'); }

// lock overlay
function openLock(mins=7){ if(locked) return; locked=true; overlay.style.display='flex'; overlay.setAttribute('aria-hidden','false'); let seconds=mins*60; countdown.textContent=formatTime(seconds); if(lockInterval) clearInterval(lockInterval); lockInterval=setInterval(()=>{ seconds--; countdown.textContent=formatTime(seconds); if(seconds<=0) closeLock(); },1000); }
function closeLock(){ locked=false; overlay.style.display='none'; overlay.setAttribute('aria-hidden','true'); if(lockInterval) clearInterval(lockInterval); }
endLock.addEventListener('click', ()=> { if(confirm('End lock early?')) closeLock(); });
function formatTime(s){ const m=Math.floor(s/60), sec=s%60; return pad(m)+':'+pad(sec); }

// Salah tracker + streaks + taraweeh
const trackerContainer = document.getElementById('tracker'), streakBadge = document.getElementById('streakBadge');
function storageKeyForDate(d){ return 'imanplay-tracker-'+d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate(); }
function loadTodayTracker(){ const today=new Date(), key=storageKeyForDate(today), raw=localStorage.getItem(key), obj={Fajr:false,Dhuhr:false,Asr:false,Maghrib:false,Isha:false}; if(raw){ try{ obj=JSON.parse(raw); }catch(e){} } return {key,obj}; }
function saveTracker(key,obj){ localStorage.setItem(key, JSON.stringify(obj)); updateStreak(); renderTracker(); }
function renderTracker(){ const {key,obj}=loadTodayTracker(); trackerContainer.innerHTML=''; ids.forEach(p=>{ const div=document.createElement('div'); div.innerHTML=`<label style="display:flex;align-items:center;gap:8px"><input type="checkbox" data-prayer="${p}" ${obj[p] ? 'checked' : ''} /> <strong>${p}</strong></label>`; trackerContainer.appendChild(div); const chk=div.querySelector('input'); chk.addEventListener('change', ()=>{ obj[p]=chk.checked; saveTracker(key,obj); }); }); }
function updateStreak(){ let count=0; const today=new Date(); for(let i=0;i<365;i++){ const d=new Date(today.getFullYear(), today.getMonth(), today.getDate()-i); const key=storageKeyForDate(d); const raw=localStorage.getItem(key); if(!raw) break; try{ const obj=JSON.parse(raw); const all=ids.every(p=>obj[p]); if(all) count++; else break; }catch(e){ break; } } streakBadge.textContent='Streak '+count; localStorage.setItem('imanplay-streak', String(count)); }
renderTracker(); updateStreak();
function computeBadges(){ const streak=parseInt(localStorage.getItem('imanplay-streak')||'0',10); const tara=parseInt(localStorage.getItem('tara-count')||'0',10); const badges=[]; if(streak>=1) badges.push('Getting Started'); if(streak>=7) badges.push('7-day streak'); if(streak>=30) badges.push('30-day warrior'); if(tara>=20) badges.push('Taraweeh 20+'); return badges; }
document.getElementById('badgesBtn').addEventListener('click', ()=> { const list=computeBadges(); alert('Badges:\\n'+(list.length?list.join('\\n'):'None yet â€” keep going!')); });

// Taraweeh
const taraCountEl=document.getElementById('taraCount'), taraInc=document.getElementById('taraInc'), taraDec=document.getElementById('taraDec'), resetTara=document.getElementById('resetTara');
function loadTara(){ const n=parseInt(localStorage.getItem('tara-count')||'0',10); taraCountEl.textContent=n; }
taraInc.addEventListener('click', ()=>{ const n=parseInt(localStorage.getItem('tara-count')||'0',10)+1; localStorage.setItem('tara-count', String(n)); loadTara(); });
taraDec.addEventListener('click', ()=>{ let n=parseInt(localStorage.getItem('tara-count')||'0',10)-1; if(n<0)n=0; localStorage.setItem('tara-count', String(n)); loadTara(); });
resetTara.addEventListener('click', ()=>{ if(confirm('Reset Taraweeh counter?')){ localStorage.setItem('tara-count','0'); loadTara(); }});
loadTara();

// Hadith & Dua
const hadiths = ["Actions are judged by intentions. â€” Prophet Muhammad (peace be upon him).", "The best among you are those who have the best manners and character."];
const duas = ["Our Lord, give us in this world that which is good and in the Hereafter that which is good.", "O Allah, increase me in knowledge and grant me beneficial knowledge."];
document.getElementById('hadith').textContent = hadiths[new Date().getDate() % hadiths.length];
document.getElementById('dua').textContent = duas[new Date().getDate() % duas.length];

// geolocation & init
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(pos => loadTimes(pos.coords.latitude, pos.coords.longitude), err => loadTimes(), {timeout:7000});
} else loadTimes();

// prevent closing while locked
window.addEventListener('beforeunload', (e) => { if (locked) { e.preventDefault(); e.returnValue = ''; } });

// developer helper
window.imanplay = { showSystemNotification };

// restore UI state
(soundSelect.value = localStorage.getItem('sound') || soundSelect.value);
(lockRange.value = localStorage.getItem('lockMins') || lockRange.value);
lockLabel.textContent = lockRange.value + 'm';
</script>

</body>
</html>
